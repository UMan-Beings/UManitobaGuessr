name: ci pipeline

on:
  push:
    # run tests on all branches
    branches:
      - '**'
  pull_request:
    # run tests on prs to main
    branches: main
  workflow_dispatch:

jobs:
  test-build-backend:
    runs-on: ubuntu-latest
    # this job runs tests for all branches
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: myuser
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: mydatabase
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # step 1: checkout repository
      - name: checkout repository
        uses: actions/checkout@v4

      # step 2: set up java 21
      - name: set up java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # step 3: make gradle wrapper executable
      - name: make gradlew executable
        working-directory: backend
        run: chmod +x gradlew

      # step 4: cache gradle dependencies and wrapper
      - name: cache gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/**/*.gradle*', 'backend/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ hashFiles('backend/gradle.properties') }}-
            ${{ runner.os }}-gradle-

      # step 5: wait for postgres to be ready
      # we need postgres running for integration tests
      - name: wait for postgres
        run: |
          until pg_isready -h localhost -p 5432 -U myuser; do
            echo "waiting for postgres..."
            sleep 2
          done

      # step 6: run backend tests on runner (not in docker)
      - name: run backend tests
        working-directory: backend
        run: ./gradlew test

      #### INCLUDE THIS IF we want pr suggestions in the ci
      # step 7: run sonarcloud analysis
      # - name: run sonarcloud scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   with:
      #     projectKey: your_project_key
      #     organization: your_organization
      #   env:
      #     SONAR_TOKEN: ${{secrets.SONAR_TOKEN}}

      # step 8: build backend jar (only for main branch)
      - name: build backend jar
        if: github.ref == 'refs/heads/main'
        working-directory: backend
        run: ./gradlew build -x test

      # step 9: upload backend jar artifact (only for main branch)
      - name: upload backend jar
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: tested-backend-jar
          path: backend/build/libs/*.jar

  build-backend-image:
    runs-on: ubuntu-latest
    needs: test-build-backend
    if: github.ref == 'refs/heads/main'  # only build image on main

    steps:
      # step 1: checkout repository
      - name: checkout repository
        uses: actions/checkout@v4

      # step 2: download jar artifact from previous job
      - name: download backend jar
        uses: actions/download-artifact@v3
        with:
          name: tested-backend-jar
          path: backend/build/libs/

      # step 3: read backend version and seet image tag
      - name: read backend version
        run: |
          VER=$(grep backend version.txt | cut -d '=' -f2)
          IMG_TAG=${VER}-{GITHUB_SHA::8}
          # make varialbes available to all steps within THIS job
          echo "VER=$VER" >> $GITHUB_ENV
          echo "IMG_TAG=$IMG_TAG" >> $GITHUB_ENV

      # step 4: build docker image using jar
      - name: build backend docker image
        run: |
          docker compose build backend
          docker tag springboot-backend:latest springboot-backend:$IMG_TAG
          docker tag springboot-backend:latest springboot-backend:latest

      # step 5: save docker image as tar for later upload
      - name: save backend docker image
        run: docker save springboot-backend:latest -o backend-image.tar

      # step 6: upload docker image artifact
      - name: upload backend docker image
        uses: actions/upload-artifact@v3
        with:
          name: backend-docker-image
          path: backend-image.tar

  push-backend-image:
    runs-on: ubuntu-latest
    needs: build-backend-image
    if: github.ref == 'refs/heads/main'  # only push on main

    steps:
      # step 1: checkout repository
      - name: checkout repository
        uses: actions/checkout@v4

      # step 2: read backend version and seet image tag
      - name: read backend version
        run: |
          VER=$(grep backend version.txt | cut -d '=' -f2)
          IMG_TAG=${VER}-{GITHUB_SHA::8}
          # make varialbes available to all steps within THIS job
          echo "VER=$VER" >> $GITHUB_ENV
          echo "IMG_TAG=$IMG_TAG" >> $GITHUB_ENV

      # step 2: download docker image artifact
      - name: download docker image artifact
        uses: actions/download-artifact@v3
        with:
          name: backend-docker-image
          path: backend-image.tar

      # step 3: load docker image into docker
      - name: load docker image
        run: docker load -i backend-image.tar

      # step 4: log in to github container registry
      - name: log in to ghcr
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # step 5: tag docker image for ghcr
      - name: tag docker image
        run: |
          docker tag springboot-backend:latest ghcr.io/${{ github.repository_owner }}/springboot-backend:$IMAGE_TAG
          docker tag springboot-backend:latest ghcr.io/${{ github.repository_owner }}/springboot-backend:latest

      # step 6: push docker image to ghcr
      - name: push docker image
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/springboot-backend:$IMAGE_TAG
          docker push ghcr.io/${{ github.repository_owner }}/springboot-backend:latest
